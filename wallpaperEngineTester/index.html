<!doctype html>

<html lang="en">

<head>

    <title>tjhrulz's Wallpaper Engine Tester</title>
    <script type="application/javascript">
        var reconnect;

        function open() {
            try {
                var url = "ws://127.0.0.1:58932/";
                ws = new WebSocket(url);
                ws.onopen = onOpen;
                ws.onclose = onClose;
                ws.onmessage = onMessage;
                ws.onerror = onError;

                //document.getElementById('content').innerHTML += "\nOpening websocket";
            } catch (error) {
                //document.getElementById('content').innerHTML += "\nError:" + error;
            }
        }

        var onOpen = function() {
            //document.getElementById('content').innerHTML += "\nOpened websocket";
            connected = true;
            clearTimeout(reconnect);
        };

        var onClose = function() {
            //document.getElementById('content').innerHTML += "\nClosed websocket";
            connected = false;
            reconnect = setTimeout(function() {
                open();
            }, 5000);
        };

        var onMessage = function(event) {
            //document.getElementById('content').innerHTML = "\nMessage received:" + event.data;

            //Gets the href of X video in search page
            //document.getElementsByClassName("style-scope ytd-two-column-search-results-renderer")[1].children[0].children[1].children[0].children[2].children[X].children[0].children[0].children[0].href

            //https://www.youtube.com/watch?v=Jo9wJaFl1Ww
            //"https://www.youtube.com/embed/Jo9wJaFl1Ww?rel=0&amp;controls=0&amp;showinfo=0

            matchString = "watch?v=";
            videoUrl = event.data
            videoUrl = videoUrl.substring(videoUrl.lastIndexOf(matchString) + matchString.length, videoUrl.length - 1)

            //newSource = "https://www.youtube.com/embed/" + videoUrl + "?rel=0&amp;controls=0&amp;showinfo=0;autoplay=1";
            //document.getElementById("iframe").src = newSource;
            //document.getElementById('content').innerHTML = "New URL:" + newSource;

            player.loadVideoById(videoUrl, 2)
        };

        var onError = function(event) {
            if (typeof event.data != 'undefined') {
                //document.getElementById('content').innerHTML += "\nWebsocket Error:" + event.data;
            }
        };

        function sendMessage(stringToSend) {
            if (connected) {
                ws.send(stringToSend);
            }
        }
    </script>
</head>

<body style="padding: 0px; margin: 0px; background-color: DimGray;">
    <div id="player"></div>

    <script type="text/javascript">
        // 2. This code loads the IFrame Player API code asynchronously.
        var tag = document.createElement('script');

        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        // 3. This function creates an <iframe> (and YouTube player)
        //    after the API code downloads.
        var player;

        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '1080',
                width: '1920',
                videoId: 'xJ6IoIBohbM',
                playerVars: {
                    'autoplay': 0,
                    'showinfo': 0,
                    'controls': 0,
                    'rel': 0
                },
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange
                }
            });
            player.mute();
        }

        // 4. The API will call this function when the video player is ready.
        function onPlayerReady(event) {
            event.target.playVideo();
        }

        // 5. The API calls this function when the player's state changes.
        //    The function indicates that when playing a video (state=1),
        //    the player should play for six seconds and then stop.
        var done = false;

        function onPlayerStateChange(event) {
            player.mute();
            if (event.data == YT.PlayerState.PLAYING && !done) {
                //@TODO send video has started back to rainemter
            }
            //@TODO Send video has been paused back to rainmeter
        }

        open();
    </script>
</body>

</html>
